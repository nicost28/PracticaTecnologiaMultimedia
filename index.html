<!DOCTYPE html>
<html lang="en">

<!-- =========================================
     SECCI√ìN: HEAD - Metadatos y Estilos
     ========================================= -->
<head>
  <meta charset="utf-8">
  <meta content="width=device-width, initial-scale=1.0" name="viewport">
  <title>Mallorca Asi√°tico</title>
  <meta name="description" content="">
  <meta name="keywords" content="">

  <!-- Leaflet - Librer√≠a de mapas -->
  <link rel="stylesheet" href="https://unpkg.com/leaflet@1.9.3/dist/leaflet.css" integrity="sha256-kLaT2GOSpHechhsozzB+flnD+zUyjE2LlfWPgU04xyI=" crossorigin="" />
  <script src="https://unpkg.com/leaflet@1.9.3/dist/leaflet.js" integrity="sha256-WBkoXOwTeyKclOHuWtc+i2uENFpDZ9YPdf5Hf+D7ewM=" crossorigin=""></script>

  <!-- Favicons -->
  <link href="assets/img/mallorcaAsiatico.svg" rel="icon">
  <link href="assets/img/apple-touch-icon.png" rel="apple-touch-icon">

  <!-- Fuentes -->
  <link href="https://fonts.googleapis.com" rel="preconnect">
  <link href="https://fonts.gstatic.com" rel="preconnect" crossorigin>
  <link href="https://fonts.googleapis.com/css2?family=Roboto:ital,wght@0,100;0,300;0,400;0,500;0,700;0,900;1,100;1,300;1,400;1,500;1,700;1,900&family=Poppins:ital,wght@0,100;0,200;0,300;0,400;0,500;0,600;0,700;0,800;0,900;1,100;1,200;1,300;1,400;1,500;1,600;1,700;1,800;1,900&family=Satisfy:wght@400&display=swap" rel="stylesheet">

  <!-- CSS de Vendor -->
  <link href="assets/vendor/bootstrap/css/bootstrap.min.css" rel="stylesheet">
  <link href="assets/vendor/bootstrap-icons/bootstrap-icons.css" rel="stylesheet">
  <link href="assets/vendor/aos/aos.css" rel="stylesheet">
  <link href="assets/vendor/glightbox/css/glightbox.min.css" rel="stylesheet">
  <link href="assets/vendor/swiper/swiper-bundle.min.css" rel="stylesheet">

  <!-- CSS Principal -->
  <link href="assets/css/main.css" rel="stylesheet">

  <!-- =======================================================
  * Template Name: Delicious
  * Template URL: https://bootstrapmade.com/delicious-free-restaurant-bootstrap-theme/
  * Updated: Aug 07 2024 with Bootstrap v5.3.3
  * Author: BootstrapMade.com
  * License: https://bootstrapmade.com/license/
  ======================================================== -->
</head>

<!-- =========================================
     SECCI√ìN: BODY - Inicio de contenido
     ========================================= -->
<body class="index-page">

  <!-- =========================================
       SECCI√ìN: HEADER - Navegaci√≥n principal
       ========================================= -->
  <header id="header" class="header fixed-top">
    <div class="branding d-flex align-items-cente">
      <div class="container position-relative d-flex align-items-center justify-content-between">
        <a href="index.html" class="logo d-flex align-items-center">
          <!-- Logo de la marca -->
          <img src="assets/img/mallorcaAsiatico.svg" alt="">
        </a>

        <!-- Men√∫ de navegaci√≥n -->
        <nav id="navmenu" class="navmenu">
          <ul>
            <li><a href="#hero" class="active">Home</a></li>
            <li><a href="login.html" id="login-btn">Iniciar Sesi√≥n</a></li>
            <li><a href="#why-us">Mapa</a></li>
            <li><a href="#restaurantes">Lista Restaurantes</a></li>
          </ul>
          <i class="mobile-nav-toggle d-xl-none bi bi-list"></i>
        </nav>
      </div>
    </div>
  </header>

  <!-- =========================================
       SECCI√ìN: MAIN - Contenido principal
       ========================================= -->
  <main class="main">

    <!-- =========================================
         SUBSECCI√ìN: Hero - Carrusel e introducci√≥n
         ========================================= -->
    <section id="hero" class="hero section dark-background">
      <div id="hero-carousel" class="carousel-fade" role="button">

        <div class="carousel-item active">
          <img src="assets/img/hero-carousel/hero-carousel-1.jpg" alt="" class="d-block w-100">
          <div class="carousel-container">
            <h2><span>Mallorca</span> Asi√°tico</h2>
          </div>
        </div><div class="video-overlay">
          <video class="hero-video" autoplay muted playsinline loop controls>
            <source src="assets/img/hero-videos/video1.mp4" type="video/mp4">
          </video>
        </div>

      </div>
    </section>```

**Cambios realizados:**

* **Mantenemos la clase `carousel-fade`:** Esto podr√≠a estar proporcionando alg√∫n estilo de transici√≥n o efecto de opacidad que deseas conservar. Si no es as√≠, tambi√©n puedes eliminarla.
* **Eliminamos los items innecesarios:** Dejamos solo el `carousel-item` que contiene la imagen `hero-carousel-1.jpg`.
* **Aseguramos que la imagen ocupe todo el ancho:** A√±adimos las clases `d-block w-100` a la etiqueta `img`. Esto asegura que la imagen se muestre correctamente dentro del contenedor del carrusel.
* **Eliminamos los controles:** Quitamos las flechas de navegaci√≥n y los indicadores.
* **Dejamos solo el video deseado:** Eliminamos el segundo `source` dentro de la etiqueta `video`, dejando solo `video1.mp4`.

Con estos cambios, la secci√≥n Hero mostrar√° una √∫nica imagen (`hero-carousel-1.jpg`) y un √∫nico video (`video1.mp4`) de forma est√°tica, manteniendo el resto de la estructura y estilos que ten√≠as.

  

<!-- =========================================
     SUBSECCI√ìN: Mapa 
========================================= -->
<main class="main">
  <div class="main-container">
    <section id="why-us" class="why-us section" style="padding-top: 80px;">
      <div class="container section-title" data-aos="fade-up" style="position: relative;">
        <h2 style="margin-bottom: 40px;">
          <span class="palabra-izq">Mapa de</span>
          <span class="palabra-der">Restaurantes</span>
        </h2>
        <button id="filtro-michelin" class="btn btn-sm btn-outline-danger" style="position: absolute; top: 0; right: 0;"
          onclick="cambiarTipoRestaurantes()">
          Ver restaurantes Estrella Michelin
        </button>
      </div>

  <div id="mi_mapa"
       style="width: 90%; height: 600px; margin: 30px auto 20px auto; border-radius: 15px;">
  </div>

  <script>
    const ORS_API_KEY = '5b3ce3597851110001cf6248e49a52899cc74f529a099cb78fdb53b0';
    const defaultCoords = [39.64213, 2.97582];

    let map, userMarker, routeLayer;
    let activeRouteButton = null;
    let currentMarkers = [];
    let showingMichelin = false;

    const redIcon = L.icon({
      iconUrl: 'https://raw.githubusercontent.com/pointhi/leaflet-color-markers/master/img/marker-icon-2x-red.png',
      iconSize: [25, 41],
      iconAnchor: [12, 41],
      popupAnchor: [1, -34]
    });

    function initMap(coords = defaultCoords) {
      if (map) map.remove();
      map = L.map('mi_mapa').setView(coords, 12);
      L.tileLayer('https://{s}.tile.openstreetmap.org/{z}/{x}/{y}.png').addTo(map);
    }

    async function cargarRestaurantesEnMapa() {
      try {
        const path = showingMichelin
          ? 'OtrosJSON/restaurantesMichellin.json'
          : 'RESTAURANTES_ASIA.json';

        const resp = await fetch(path);
        const data = await resp.json();

        // Limpia marcadores previos
        currentMarkers.forEach(m => map.removeLayer(m));
        currentMarkers = [];

        // Unifica ambos esquemas: restaurants o itemListElement
        let restaurantes = [];
        if (Array.isArray(data.restaurants)) {
          restaurantes = data.restaurants;
        } else if (Array.isArray(data.itemListElement)) {
          restaurantes = data.itemListElement.map(el => el.item || el);
        }

        restaurantes.forEach(r => {
          const lat = parseFloat(r.geo?.latitude);
          const lng = parseFloat(r.geo?.longitude);
          if (!isNaN(lat) && !isNaN(lng)) {
            const marker = L.marker([lat, lng]).addTo(map);
            currentMarkers.push(marker);

            marker.bindPopup(`
              <b>${r.name}</b><br>
              ${showingMichelin ? `‚≠ê ${r.award}<br>` : ''}
              <button class="btn-route"
                      data-coords='${JSON.stringify([lat, lng])}'
                      onclick="handleRouteButton(this)">
                üöó Calcular ruta
              </button>
            `);
          }
        });

      } catch (err) {
        alert("Error cargando restaurantes: " + err.message);
      }
    }

    function cambiarTipoRestaurantes() {
      showingMichelin = !showingMichelin;
      document.getElementById('filtro-michelin').textContent = showingMichelin
        ? 'Ver restaurantes asi√°ticos'
        : 'Ver restaurantes Estrella Michelin';
      cargarRestaurantesEnMapa();
    }

    function handleRouteButton(button) {
      const dest = JSON.parse(button.dataset.coords);
      if (button.textContent.includes('Calcular')) {
        calculateRoute(dest, button);
      } else {
        clearRoute(button);
      }
    }

    async function calculateRoute([lat, lng], button) {
      try {
        const userCoords = JSON.parse(localStorage.getItem('userLocation'));
        if (!userCoords) {
          alert('¬°Primero activa tu ubicaci√≥n!');
          return;
        }
        if (activeRouteButton) clearRoute(activeRouteButton);

        const start = `${userCoords[1]},${userCoords[0]}`;
        const end = `${lng},${lat}`;
        const url = `https://api.openrouteservice.org/v2/directions/driving-car?api_key=${ORS_API_KEY}&start=${start}&end=${end}`;

        const res = await fetch(url);
        const js = await res.json();

        if (routeLayer) map.removeLayer(routeLayer);
        routeLayer = L.geoJSON(js.features[0], {
          style: { color: '#FF6B6B', weight: 5 }
        }).addTo(map);

        map.fitBounds(routeLayer.getBounds());
        button.textContent = 'üó∫Ô∏è Dejar de ver ruta';
        activeRouteButton = button;

      } catch (e) {
        alert(`Error calculando la ruta: ${e.message}`);
      }
    }

    function clearRoute(button) {
      if (routeLayer) {
        map.removeLayer(routeLayer);
        routeLayer = null;
      }
      button.textContent = 'üöó Calcular ruta';
      activeRouteButton = null;
    }

    function handleGeolocation() {
      if (navigator.geolocation) {
        navigator.geolocation.getCurrentPosition(pos => {
          const coords = [pos.coords.latitude, pos.coords.longitude];
          localStorage.setItem('userLocation', JSON.stringify(coords));
          if (userMarker) map.removeLayer(userMarker);
          userMarker = L.marker(coords, { icon: redIcon })
            .addTo(map)
            .bindPopup('<b>Tu ubicaci√≥n actual</b>')
            .openPopup();
          map.setView(coords, 16);
        }, () => alert('¬°Necesitamos tu ubicaci√≥n para calcular rutas!'));
      }
    }

    document.addEventListener('DOMContentLoaded', () => {
      initMap();
      handleGeolocation();
      cargarRestaurantesEnMapa();
    });
  </script>
</section>


<!-- =========================================
     SUBSECCI√ìN: Restaurantes - Recomendaci√≥n din√°mica
========================================= -->
<section id="restaurantes" class="restaurantes section">
  <div class="container section-title position-relative d-flex justify-content-center align-items-center mb-5" data-aos="fade-up">
    <h2 class="text-center mb-0">Nuestra Recomendaci√≥n</h2>
    <div style="position: absolute; top: 0; right: 0;">
      <select id="filtro-restaurantes" class="form-select" style="width: 260px;" onchange="ordenarRestaurantes()">
        <option value="alfabetico">Ordenar alfab√©ticamente</option>
        <option value="proximidad">Por proximidad</option>
        <option value="valoracion">Por valoraci√≥n media</option>
        <option value="abiertos">Solo abiertos ahora</option>
      </select>
    </div>
  </div>

  <div class="container">
    <div class="row justify-content-center" id="restaurante-container" data-aos="fade-up" data-aos-delay="100">
      <div class="col-lg-8">
        <div class="card mb-4">
          <div class="card-body text-center">
            <h3 class="card-title">Cargando informaci√≥n...</h3>
            <div class="spinner-border" role="status"></div>
          </div>
        </div>
      </div>
    </div>
  </div>

  <script>
    let restaurantesOriginal = [];
    let userCoords = null;

    function horaEnMinutos(hora) {
      const [h, m] = hora.split(':').map(Number);
      return h * 60 + m;
    }

    function estaAbiertoAhora(specs) {
      if (!Array.isArray(specs) || specs.length === 0) return null;
      const now = new Date();
      const dias = ["Sunday","Monday","Tuesday","Wednesday","Thursday","Friday","Saturday"];
      const hoy = dias[now.getDay()];
      const minAhora = now.getHours() * 60 + now.getMinutes();
      for (const s of specs) {
        if (s.dayOfWeek.includes(hoy)) {
          const openMin = horaEnMinutos(s.opens);
          const closeMin = horaEnMinutos(s.closes);
          if (minAhora >= openMin && minAhora <= closeMin) {
            return true;
          }
        }
      }
      return false;
    }

    function calcularDistancia(lat1, lon1, lat2, lon2) {
      const R = 6371, rad = d => d * Math.PI/180;
      const dLat = rad(lat2 - lat1), dLon = rad(lon2 - lon1);
      const a = Math.sin(dLat/2)**2 +
                Math.cos(rad(lat1))*Math.cos(rad(lat2))*
                Math.sin(dLon/2)**2;
      return R * 2 * Math.atan2(Math.sqrt(a), Math.sqrt(1-a));
    }

    function obtenerUbicacion() {
      return new Promise((res, rej) => {
        navigator.geolocation.getCurrentPosition(
          pos => {
            const c = [pos.coords.latitude, pos.coords.longitude];
            localStorage.setItem('userLocation', JSON.stringify(c));
            res(c);
          },
          err => rej(err)
        );
      });
    }

    async function cargarRestaurantes() {
      try {
        const resp = await fetch('RESTAURANTES_ASIA.json');
        const data = await resp.json();

        // Soporta ambos esquemas
        let lista = Array.isArray(data.restaurants)
          ? data.restaurants
          : Array.isArray(data.itemListElement)
            ? data.itemListElement.map(el => el.item || el)
            : [];

        restaurantesOriginal = lista
          .map((r, i) => ({ ...r, id: i + 1 }))
          .filter(r => r.geo?.latitude && r.geo?.longitude);

        // Calcula rating promedio
        await Promise.all(restaurantesOriginal.map(async r => {
          try {
            const rev = await fetch(`get_reviews.php?restaurantId=${r.id}`);
            const js = rev.ok ? await rev.json() : [];
            r.avgRating = Array.isArray(js) && js.length
              ? js.reduce((s,v) => s + (v.rating||0), 0) / js.length
              : 0;
          } catch {
            r.avgRating = 0;
          }
        }));

        restaurantesOriginal.sort((a,b) => a.name.localeCompare(b.name));
        actualizarVista(restaurantesOriginal);
      } catch (e) {
        console.error(e);
        document.getElementById('restaurante-container').innerHTML = `
          <div class="col-lg-8">
            <div class="alert alert-danger">
              Error cargando restaurantes. Recarga la p√°gina.
            </div>
          </div>`;
      }
    }

    async function ordenarRestaurantes() {
      const modo = document.getElementById('filtro-restaurantes').value;
      let lista = [...restaurantesOriginal];

      if (modo === 'proximidad') {
        try {
          userCoords = JSON.parse(localStorage.getItem('userLocation')) 
            || await obtenerUbicacion();
          lista = lista
            .map(r => ({
              ...r,
              distancia: calcularDistancia(
                userCoords[0], userCoords[1],
                parseFloat(r.geo.latitude), parseFloat(r.geo.longitude)
              )
            }))
            .sort((a,b) => a.distancia - b.distancia);
        } catch {
          alert('Activa la geolocalizaci√≥n para usar este filtro.');
          return;
        }
      } else if (modo === 'valoracion') {
        lista.sort((a,b) => (b.avgRating||0) - (a.avgRating||0));
      } else if (modo === 'abiertos') {
        lista = lista.filter(r => estaAbiertoAhora(r.openingHoursSpecification) === true);
      } else {
        lista.sort((a,b) => a.name.localeCompare(b.name));
      }

      actualizarVista(lista);
    }

    function actualizarVista(restaurantes) {
      const cont = document.getElementById('restaurante-container');
      cont.innerHTML = '';
      restaurantes.forEach(r => {
        const full = Math.floor(r.avgRating);
        const half = (r.avgRating - full) >= 0.5 ? 1 : 0;
        const empty = 5 - full - half;
        let stars = '';
        for (let i=0; i<full; i++) stars += '<i class="bi bi-star-fill text-warning"></i>';
        if (half) stars += '<i class="bi bi-star-half text-warning"></i>';
        for (let i=0; i<empty; i++) stars += '<i class="bi bi-star text-warning"></i>';

        const dist = r.distancia != null
          ? `<p class="text-secondary mb-2">
               <i class="bi bi-signpost-split"></i> ${r.distancia.toFixed(1)} km
             </p>`
          : '';

        const estado = estaAbiertoAhora(r.openingHoursSpecification);
        const badge = estado === true
          ? '<span class="badge bg-success">Abierto ahora</span>'
          : estado === false
            ? '<span class="badge bg-secondary">Cerrado ahora</span>'
            : '<span class="badge bg-info">Horario no disponible</span>';

        const imgName = r.name.replace(/\s+/g, '');
        const col = document.createElement('div');
        col.className = 'col-lg-10 mb-4';
        col.innerHTML = `
          <div class="card restaurant-card d-flex flex-row position-relative">
            <div class="card-body flex-grow-1" style="margin-right:50px;">
              <h3 class="card-title">
                ${r.name}
                <small class="ms-2">${stars}</small>
              </h3>
              ${dist}
              <p class="mb-1">
                <i class="bi bi-geo-alt"></i>
                ${r.address.streetAddress}, ${r.address.postalCode} ${r.address.addressLocality}
              </p>
              ${r.telephone ? `
                <p class="mb-1">
                  <i class="bi bi-telephone"></i>
                  <a href="tel:${r.telephone}">${r.telephone}</a>
                </p>` : ''}
              <div class="d-flex gap-2 mt-3">
                <a href="${r.url}" target="_blank" class="btn btn-primary">
                  <i class="bi bi-globe"></i> Visitar Web
                </a>
                <a href="reviews.html?restaurantId=${r.id}" class="btn btn-outline-primary">
                  <i class="bi bi-chat-text"></i> Ver Rese√±as
                </a>
              </div>
            </div>
            <div class="image-container" style="flex-shrink:0;width:300px;">
              <img src="assets/img/restaurantes/${imgName}.png"
                   alt="${r.name}"
                   class="h-100 w-100 object-fit-cover rounded-end"
                   onerror="this.src='assets/img/restaurantes/placeholder.png'">
            </div>
            <div style="position:absolute; bottom:10px; right:320px;">
              ${badge}
            </div>
          </div>`;
        cont.appendChild(col);
      });
    }

    document.addEventListener('DOMContentLoaded', cargarRestaurantes);
  </script>
</section>


  <!-- =========================================
       CAMBIAR INICIO DE SESI√ìN POR CAMBIAR CUENTA
       ========================================= -->
<script>
    document.addEventListener('DOMContentLoaded', () => {
      const loginButton = document.getElementById('login-btn');
      const currentUser = sessionStorage.getItem('currentUser');

      if (currentUser) {
        loginButton.textContent = 'Cambiar de Cuenta';
        loginButton.href = 'login.html'; // Mant√©n el enlace a login.html o c√°mbialo si es necesario
      }
    });
  </script>






  <!-- =========================================
       SECCI√ìN: FOOTER - Pie de p√°gina
       ========================================= -->
  <footer id="footer" class="footer dark-background">
    <div class="container copyright text-center mt-4">
      <p>¬© <span>Copyright</span> <strong class="px-1 sitename">Delicious</strong> <span>All Rights Reserved</span></p>
      <div class="credits">
        Designed by <a href="https://bootstrapmade.com/">BootstrapMade</a>
      </div>
    </div>
  </footer>

  <!-- Scroll Top -->
  <a href="#" id="scroll-top" class="scroll-top d-flex align-items-center justify-content-center"><i class="bi bi-arrow-up-short"></i></a>

  <!-- Preloader -->
  <div id="preloader"></div>

  <!-- =========================================
       SECCI√ìN: Scripts - Vendor y Principal
       ========================================= -->
  <!-- Vendor JS Files -->
  <script src="assets/vendor/bootstrap/js/bootstrap.bundle.min.js"></script>
  <script src="assets/vendor/php-email-form/validate.js"></script>
  <script src="assets/vendor/aos/aos.js"></script>
  <script src="assets/vendor/glightbox/js/glightbox.min.js"></script>
  <script src="assets/vendor/imagesloaded/imagesloaded.pkgd.min.js"></script>
  <script src="assets/vendor/isotope-layout/isotope.pkgd.min.js"></script>
  <script src="assets/vendor/swiper/swiper-bundle.min.js"></script>

  <!-- Main JS File -->
  <script src="assets/js/main.js"></script>

</body>

</html>

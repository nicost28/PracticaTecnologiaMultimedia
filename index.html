<!DOCTYPE html>
<html lang="en">

<!-- =========================================
     SECCI√ìN: HEAD - Metadatos y Estilos
     ========================================= -->
<head>
  <meta charset="utf-8">
  <meta content="width=device-width, initial-scale=1.0" name="viewport">
  <title>Mallorca Asi√°tico</title>
  <meta name="description" content="">
  <meta name="keywords" content="">

  <!-- Leaflet - Librer√≠a de mapas -->
  <link rel="stylesheet" href="https://unpkg.com/leaflet@1.9.3/dist/leaflet.css" integrity="sha256-kLaT2GOSpHechhsozzB+flnD+zUyjE2LlfWPgU04xyI=" crossorigin="" />
  <script src="https://unpkg.com/leaflet@1.9.3/dist/leaflet.js" integrity="sha256-WBkoXOwTeyKclOHuWtc+i2uENFpDZ9YPdf5Hf+D7ewM=" crossorigin=""></script>

  <!-- Favicons -->
  <link href="assets/img/mallorcaAsiatico.png" rel="icon">
  <link href="assets/img/apple-touch-icon.png" rel="apple-touch-icon">

  <!-- Fuentes -->
  <link href="https://fonts.googleapis.com" rel="preconnect">
  <link href="https://fonts.gstatic.com" rel="preconnect" crossorigin>
  <link href="https://fonts.googleapis.com/css2?family=Roboto:ital,wght@0,100;0,300;0,400;0,500;0,700;0,900;1,100;1,300;1,400;1,500;1,700;1,900&family=Poppins:ital,wght@0,100;0,200;0,300;0,400;0,500;0,600;0,700;0,800;0,900;1,100;1,200;1,300;1,400;1,500;1,600;1,700;1,800;1,900&family=Satisfy:wght@400&display=swap" rel="stylesheet">

  <!-- CSS de Vendor -->
  <link href="assets/vendor/bootstrap/css/bootstrap.min.css" rel="stylesheet">
  <link href="assets/vendor/bootstrap-icons/bootstrap-icons.css" rel="stylesheet">
  <link href="assets/vendor/aos/aos.css" rel="stylesheet">
  <link href="assets/vendor/glightbox/css/glightbox.min.css" rel="stylesheet">
  <link href="assets/vendor/swiper/swiper-bundle.min.css" rel="stylesheet">

  <!-- CSS Principal -->
  <link href="assets/css/main.css" rel="stylesheet">

  <!-- =======================================================
  * Template Name: Delicious
  * Template URL: https://bootstrapmade.com/delicious-free-restaurant-bootstrap-theme/
  * Updated: Aug 07 2024 with Bootstrap v5.3.3
  * Author: BootstrapMade.com
  * License: https://bootstrapmade.com/license/
  ======================================================== -->
</head>

<!-- =========================================
     SECCI√ìN: BODY - Inicio de contenido
     ========================================= -->
<body class="index-page">

  <!-- =========================================
       SECCI√ìN: HEADER - Navegaci√≥n principal
       ========================================= -->
  <header id="header" class="header fixed-top">
    <div class="branding d-flex align-items-cente">
      <div class="container position-relative d-flex align-items-center justify-content-between">
        <a href="index.html" class="logo d-flex align-items-center">
          <!-- Logo de la marca -->
          <img src="assets/img/mallorcaAsiatico.png" alt="">
        </a>

        <!-- Men√∫ de navegaci√≥n -->
        <nav id="navmenu" class="navmenu">
          <ul>
            <li><a href="#hero" class="active">Home</a></li>
            <li><a href="login.html">Iniciar Sesi√≥n</a></li>
            <li><a href="#why-us">Mapa</a></li>
            <li><a href="#restaurantes">Lista Restaurantes</a></li>
          </ul>
          <i class="mobile-nav-toggle d-xl-none bi bi-list"></i>
        </nav>
      </div>
    </div>
  </header>

  <!-- =========================================
       SECCI√ìN: MAIN - Contenido principal
       ========================================= -->
  <main class="main">

    <!-- =========================================
         SUBSECCI√ìN: Hero - Carrusel e introducci√≥n
         ========================================= -->
    <section id="hero" class="hero section dark-background">
      <div id="hero-carousel" class="carousel slide carousel-fade" data-bs-ride="carousel" data-bs-interval="5000">

        <!-- Item del carrusel activo -->
        <div class="carousel-item active">
          <img src="assets/img/hero-carousel/asiatico-carrusel1.jpg" alt="">
          <div class="carousel-container">
            <h2><span>Mallorca</span> Asi√°tico</h2>
          </div>
        </div><!-- End Carousel Item -->

        <!-- M√°s items del carrusel -->
        <div class="carousel-item">
          <img src="assets/img/hero-carousel/hero-carousel-1.jpg" alt="">
          <div class="carousel-container">
            <h2><span>Mallorca</span> Asi√°tico</h2>
          </div>
        </div><!-- End Carousel Item -->

        <div class="carousel-item">
          <img src="assets/img/hero-carousel/hero-carousel-2.jpg" alt="">
          <div class="carousel-container">
            <h2><span>Mallorca</span> Asi√°tico</h2>
          </div>
        </div><!-- End Carousel Item -->

        <!-- Controles del carrusel -->
        <a class="carousel-control-prev" href="#hero-carousel" role="button" data-bs-slide="prev">
          <span class="carousel-control-prev-icon bi bi-chevron-left" aria-hidden="true"></span>
        </a>
        <a class="carousel-control-next" href="#hero-carousel" role="button" data-bs-slide="next">
          <span class="carousel-control-next-icon bi bi-chevron-right" aria-hidden="true"></span>
        </a>
        <ol class="carousel-indicators"></ol>

        <!-- Video superpuesto -->
        <div class="video-overlay">
          <video class="hero-video" autoplay muted playsinline loop controls>
            <source src="assets/img/hero-videos/video1.mp4" type="video/mp4">
            <source src="assets/img/hero-videos/video2.mp4" type="video/mp4">
          </video>
        </div>

      </div>
    </section><!-- /Hero Section -->

  


<!-- =========================================
     SUBSECCI√ìN: Mapa 
========================================= -->
<section id="why-us" class="why-us section">
  <div class="container section-title" data-aos="fade-up" style="position: relative;">
    <!-- T√≠tulo separado del mapa -->
    <h2 style="margin-bottom: 40px;">
      <span class="palabra-izq">Mapa de</span>
      <span class="palabra-der">Restaurantes</span>
    </h2>

    <!-- Bot√≥n alineado a la derecha absoluta -->
    <button id="filtro-michelin" 
            class="btn btn-sm btn-outline-danger"
            style="position: absolute; top: 0; right: 0;"
            onclick="cambiarTipoRestaurantes()">
      Ver restaurantes Estrella Michelin
    </button>
  </div>

  <!-- Mapa centrado y con separaci√≥n suficiente -->
  <div id="mi_mapa" style="width: 90%; height: 600px; margin: 30px auto 20px auto; border-radius: 15px;"></div>

  <script>
    const ORS_API_KEY = '5b3ce3597851110001cf6248e49a52899cc74f529a099cb78fdb53b0';
    const defaultCoords = [39.64213, 2.97582];
    
    let map, userMarker, routeLayer;
    let activeRouteButton = null;
    let currentMarkers = [];
    let showingMichelin = false;

    const redIcon = L.icon({
      iconUrl: 'https://raw.githubusercontent.com/pointhi/leaflet-color-markers/master/img/marker-icon-2x-red.png',
      iconSize: [25, 41],
      iconAnchor: [12, 41],
      popupAnchor: [1, -34]
    });

    function initMap(coords = defaultCoords) {
      if (map) map.remove();
      map = L.map('mi_mapa').setView(coords, 12);
      L.tileLayer('https://{s}.tile.openstreetmap.org/{z}/{x}/{y}.png').addTo(map);
    }

    async function cargarRestaurantesEnMapa() {
      try {
        const path = showingMichelin 
          ? 'OtrosJSON/restaurantesMichellin.json' 
          : 'RESTAURANTES_ASIA.json';
        
        const resp = await fetch(path);
        const data = await resp.json();
        
        currentMarkers.forEach(marker => map.removeLayer(marker));
        currentMarkers = [];

        const restaurantes = showingMichelin 
          ? data.itemListElement.map(item => item.item) 
          : data.restaurants;

        restaurantes.forEach(r => {
          if (r.geo && r.geo.latitude && r.geo.longitude) {
            const coords = [
              parseFloat(r.geo.latitude), 
              parseFloat(r.geo.longitude)
            ];
            
            const marker = L.marker(coords).addTo(map);
            currentMarkers.push(marker);

            marker.bindPopup(`
              <b>${r.name}</b><br>
              ${showingMichelin ? `‚≠ê ${r.award}<br>` : ''}
              <button class="btn-route" 
                      data-coords='${JSON.stringify(coords)}'
                      onclick="handleRouteButton(this)">
                üöó Calcular ruta
              </button>
            `);
          }
        });

      } catch (err) {
        alert("Error cargando restaurantes: " + err.message);
      }
    }

    function cambiarTipoRestaurantes() {
      showingMichelin = !showingMichelin;
      document.getElementById('filtro-michelin').textContent = showingMichelin
        ? 'Ver restaurantes asi√°ticos'
        : 'Ver restaurantes Estrella Michelin';
      
      cargarRestaurantesEnMapa();
    }

    function handleRouteButton(button) {
      const destinationCoords = JSON.parse(button.dataset.coords);

      if (button.textContent.includes('Calcular')) {
        calculateRoute(destinationCoords, button);
      } else {
        clearRoute(button);
      }
    }

    async function calculateRoute(destinationCoords, button) {
      try {
        const userCoords = JSON.parse(localStorage.getItem('userLocation'));
        if (!userCoords) {
          alert('¬°Primero activa tu ubicaci√≥n!');
          return;
        }

        if (activeRouteButton) clearRoute(activeRouteButton);

        const start = `${userCoords[1]},${userCoords[0]}`;
        const end = `${destinationCoords[1]},${destinationCoords[0]}`;

        const url = `https://api.openrouteservice.org/v2/directions/driving-car?api_key=${ORS_API_KEY}&start=${start}&end=${end}`;
        const response = await fetch(url);
        const data = await response.json();

        if (routeLayer) map.removeLayer(routeLayer);
        routeLayer = L.geoJSON(data.features[0], {
          style: { color: '#FF6B6B', weight: 5 }
        }).addTo(map);

        map.fitBounds(routeLayer.getBounds());
        button.textContent = 'üó∫Ô∏è Dejar de ver ruta';
        activeRouteButton = button;

      } catch (error) {
        alert(`Error calculando la ruta: ${error.message}`);
      }
    }

    function clearRoute(button) {
      if (routeLayer) {
        map.removeLayer(routeLayer);
        routeLayer = null;
      }
      button.textContent = 'üöó Calcular ruta';
      activeRouteButton = null;
    }

    function handleGeolocation() {
      if (navigator.geolocation) {
        navigator.geolocation.getCurrentPosition(
          position => {
            const userCoords = [position.coords.latitude, position.coords.longitude];
            localStorage.setItem('userLocation', JSON.stringify(userCoords));

            if (userMarker) map.removeLayer(userMarker);
            userMarker = L.marker(userCoords, { icon: redIcon })
              .addTo(map)
              .bindPopup('<b>Tu ubicaci√≥n actual</b>')
              .openPopup();

            map.setView(userCoords, 16);
          },
          () => alert('¬°Necesitamos tu ubicaci√≥n para calcular rutas!')
        );
      }
    }

    document.addEventListener('DOMContentLoaded', () => {
      initMap();
      handleGeolocation();
      cargarRestaurantesEnMapa();
    });
  </script>
</section><!-- /MAPA Section -->

<!-- =========================================
     SUBSECCI√ìN: Restaurantes - Recomendaci√≥n din√°mica
     ========================================= -->
     <section id="restaurantes" class="restaurantes section">
      <div class="container section-title position-relative d-flex justify-content-center align-items-center mb-5" data-aos="fade-up">
        <h2 class="text-center mb-0">Nuestra Recomendaci√≥n</h2>
        <!-- Filtro a la derecha -->
        <div style="position: absolute; top: 0; right: 0;">
          <select id="filtro-restaurantes" class="form-select" style="width: 260px;" onchange="ordenarRestaurantes()">
            <option value="alfabetico">Ordenar alfab√©ticamente</option>
            <option value="proximidad">Por proximidad</option>
            <option value="valoracion">Por valoraci√≥n media</option>
            <option value="abiertos">Solo abiertos ahora</option>
          </select>
        </div>
      </div>
    
      <div class="container">
        <div class="row justify-content-center" id="restaurante-container" data-aos="fade-up" data-aos-delay="100">
          <!-- Placeholder mientras carga -->
          <div class="col-lg-8">
            <div class="card mb-4">
              <div class="card-body text-center">
                <h3 class="card-title">Cargando informaci√≥n...</h3>
                <div class="spinner-border" role="status"></div>
              </div>
            </div>
          </div>
        </div>
      </div>
    
      <script>
        let restaurantesOriginal = [];
        let userCoords = null;
    
        // Convierte hora "HH:MM" en minutos desde medianoche
        function horaEnMinutos(hora) {
          const [h, m] = hora.split(':').map(Number);
          return h * 60 + m;
        }
    
        // Comprueba si est√° abierto ahora; devuelve true/false, o null si no hay horario
        function estaAbiertoAhora(specs) {
          if (!Array.isArray(specs) || specs.length === 0) return null;
          const now = new Date();
          const dayNames = ["Sunday","Monday","Tuesday","Wednesday","Thursday","Friday","Saturday"];
          const hoy = dayNames[now.getDay()];
          const minutosAhora = now.getHours() * 60 + now.getMinutes();
          for (const s of specs) {
            if (s.dayOfWeek.includes(hoy)) {
              const openMin = horaEnMinutos(s.opens);
              const closeMin = horaEnMinutos(s.closes);
              if (minutosAhora >= openMin && minutosAhora <= closeMin) {
                return true;
              }
            }
          }
          return false;
        }
    
        // Haversine para distancia
        function calcularDistancia(lat1, lon1, lat2, lon2) {
          const R = 6371, toRad = d => d * Math.PI/180;
          const dLat = toRad(lat2 - lat1), dLon = toRad(lon2 - lon1);
          const a = Math.sin(dLat/2)**2 +
                    Math.cos(toRad(lat1))*Math.cos(toRad(lat2))*
                    Math.sin(dLon/2)**2;
          return R * 2 * Math.atan2(Math.sqrt(a), Math.sqrt(1-a));
        }
    
        // Pide geolocalizaci√≥n si es necesario
        function obtenerUbicacion() {
          return new Promise((res, rej) => {
            navigator.geolocation.getCurrentPosition(
              pos => {
                const coords = [pos.coords.latitude, pos.coords.longitude];
                localStorage.setItem('userLocation', JSON.stringify(coords));
                res(coords);
              },
              err => rej(err)
            );
          });
        }
    
        // Carga restaurantes y calcula avgRating
        async function cargarRestaurantes() {
          try {
            const resp = await fetch('RESTAURANTES_ASIA.json');
            const data = await resp.json();
            restaurantesOriginal = data.restaurants
              .map((r,i) => ({ ...r, id: i+1 }))
              .filter(r => r.geo && r.geo.latitude && r.geo.longitude);
    
            // Obtener rese√±as y calcular media
            await Promise.all(restaurantesOriginal.map(async r => {
              try {
                const revResp = await fetch(`get_reviews.php?restaurantId=${r.id}`);
                const reviews = revResp.ok ? await revResp.json() : [];
                r.avgRating = (Array.isArray(reviews) && reviews.length)
                  ? reviews.reduce((sum,v)=>sum + (v.rating||0), 0) / reviews.length
                  : 0;
              } catch {
                r.avgRating = 0;
              }
            }));
    
            // Orden alfab√©tico por defecto
            restaurantesOriginal.sort((a,b)=> a.name.localeCompare(b.name));
            actualizarVista(restaurantesOriginal);
          } catch (e) {
            console.error(e);
            document.getElementById('restaurante-container').innerHTML = `
              <div class="col-lg-8">
                <div class="alert alert-danger">
                  Error cargando restaurantes. Recarga la p√°gina.
                </div>
              </div>`;
          }
        }
    
        // Aplica el filtro seleccionado
        async function ordenarRestaurantes() {
          const modo = document.getElementById('filtro-restaurantes').value;
          let lista = [...restaurantesOriginal];
    
          if (modo === 'proximidad') {
            try {
              userCoords = JSON.parse(localStorage.getItem('userLocation')) 
                || await obtenerUbicacion();
              lista = lista
                .map(r => ({
                  ...r,
                  distancia: calcularDistancia(
                    userCoords[0], userCoords[1],
                    parseFloat(r.geo.latitude), parseFloat(r.geo.longitude)
                  )
                }))
                .sort((a,b)=> a.distancia - b.distancia);
            } catch {
              alert('Activa la geolocalizaci√≥n para usar este filtro.');
              return;
            }
          } else if (modo === 'valoracion') {
            lista.sort((a,b)=> (b.avgRating||0) - (a.avgRating||0));
          } else if (modo === 'abiertos') {
            lista = lista.filter(r=> estaAbiertoAhora(r.openingHoursSpecification) === true);
          } else {
            lista.sort((a,b)=> a.name.localeCompare(b.name));
          }
    
          actualizarVista(lista);
        }
    
        // Renderiza las tarjetas con estrellas, distancia y estado
        function actualizarVista(restaurantes) {
          const cont = document.getElementById('restaurante-container');
          cont.innerHTML = '';
          restaurantes.forEach(r => {
            // Estrellas
            const full = Math.floor(r.avgRating||0);
            const half = ((r.avgRating||0) - full) >= 0.5 ? 1 : 0;
            const empty = 5 - full - half;
            let starsHtml = '';
            for (let i=0;i<full;i++)  starsHtml += '<i class="bi bi-star-fill text-warning"></i>';
            if (half) starsHtml       += '<i class="bi bi-star-half text-warning"></i>';
            for (let i=0;i<empty;i++) starsHtml += '<i class="bi bi-star text-warning"></i>';
    
            // Distancia
            const distHtml = r.distancia!=null
              ? `<p class="text-secondary mb-2">
                   <i class="bi bi-signpost-split"></i> ${r.distancia.toFixed(1)} km
                 </p>`
              : '';
    
            // Estado abierto/cerrado/no disponible
            const estado = estaAbiertoAhora(r.openingHoursSpecification);
            let badge = '';
            if (estado === true)      badge = '<span class="badge bg-success">Abierto ahora</span>';
            else if (estado === false) badge = '<span class="badge bg-secondary">Cerrado ahora</span>';
            else                       badge = '<span class="badge bg-info">Horario no disponible</span>';
    
            const imgName = r.name.replace(/\s+/g,'');
            const col = document.createElement('div');
            col.className = 'col-lg-10 mb-4';
            col.innerHTML = `
              <div class="card restaurant-card d-flex flex-row position-relative">
                <div class="card-body flex-grow-1" style="margin-right:50px;">
                  <h3 class="card-title">
                    ${r.name}
                    <small class="ms-2">${starsHtml}</small>
                  </h3>
                  ${distHtml}
                  <p class="mb-1">
                    <i class="bi bi-geo-alt"></i>
                    ${r.address.streetAddress}, ${r.address.postalCode} ${r.address.addressLocality}
                  </p>
                  ${r.telephone
                    ? `<p class="mb-1">
                         <i class="bi bi-telephone"></i>
                         <a href="tel:${r.telephone}">${r.telephone}</a>
                       </p>`
                    : ''}
                  <div class="d-flex gap-2 mt-3">
                    <a href="${r.url}" target="_blank" class="btn btn-primary">
                      <i class="bi bi-globe"></i> Visitar Web
                    </a>
                    <a href="reviews.html?restaurantId=${r.id}" class="btn btn-outline-primary">
                      <i class="bi bi-chat-text"></i> Ver Rese√±as
                    </a>
                  </div>
                </div>
                <div class="image-container" style="flex-shrink:0;width:300px;">
                  <img src="assets/img/restaurantes/${imgName}.png"
                       alt="${r.name}"
                       class="h-100 w-100 object-fit-cover rounded-end"
                       onerror="this.src='assets/img/restaurantes/placeholder.png'">
                </div>
                <!-- Badge estado abajo derecha antes de la imagen -->
                <div style="position:absolute; bottom:10px; right:320px;">
                  ${badge}
                </div>
              </div>`;
            cont.appendChild(col);
          });
        }
    
        document.addEventListener('DOMContentLoaded', cargarRestaurantes);
      </script>
    </section><!-- /Restaurantes Section -->
    



  <!-- =========================================
       SECCI√ìN: FOOTER - Pie de p√°gina
       ========================================= -->
  <footer id="footer" class="footer dark-background">
    <div class="container copyright text-center mt-4">
      <p>¬© <span>Copyright</span> <strong class="px-1 sitename">Delicious</strong> <span>All Rights Reserved</span></p>
      <div class="credits">
        Designed by <a href="https://bootstrapmade.com/">BootstrapMade</a>
      </div>
    </div>
  </footer>

  <!-- Scroll Top -->
  <a href="#" id="scroll-top" class="scroll-top d-flex align-items-center justify-content-center"><i class="bi bi-arrow-up-short"></i></a>

  <!-- Preloader -->
  <div id="preloader"></div>

  <!-- =========================================
       SECCI√ìN: Scripts - Vendor y Principal
       ========================================= -->
  <!-- Vendor JS Files -->
  <script src="assets/vendor/bootstrap/js/bootstrap.bundle.min.js"></script>
  <script src="assets/vendor/php-email-form/validate.js"></script>
  <script src="assets/vendor/aos/aos.js"></script>
  <script src="assets/vendor/glightbox/js/glightbox.min.js"></script>
  <script src="assets/vendor/imagesloaded/imagesloaded.pkgd.min.js"></script>
  <script src="assets/vendor/isotope-layout/isotope.pkgd.min.js"></script>
  <script src="assets/vendor/swiper/swiper-bundle.min.js"></script>

  <!-- Main JS File -->
  <script src="assets/js/main.js"></script>

</body>

</html>
